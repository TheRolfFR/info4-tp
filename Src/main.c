/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed by ST under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <string.h>
#include <stm32f4xx.h>
#include "usart.h"

char res;

#define USART_BUFFER_SIZE 200
char buffer[USART_BUFFER_SIZE];

int32_t effectiveSize = -1;

int main(void)
{
	// 1. Configuration des GPIOs
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
	GPIOA->MODER |= 0x000000A0;
	GPIOA->MODER &= 0xFFFFFFAF;
	GPIOA->AFR[0] &= 0xFFFF77FF;
	GPIOA->AFR[0] |= 0x00007700;

	memset(buffer, 0, USART_BUFFER_SIZE);
	USART2_Init(115200);

	// 2.1.1. Envoi d’une donnée 8bits
//	__io_putchar('h');

	char msg[] = "Hello World!\r\n";
	(void) msg;
	for(;;) {
		// 2.1.2. Envoi d’une trame
//		USART2_Transmit((uint8_t*) msg, sizeof(msg));

		// 2.2.1. Réception d’une donnée unique
//		res = __io_getchar() & 0xFF;
//		__io_putchar(res); // afficher derrière

		// 2.2.2. Réception d’une trame (bloquant puis délai)
		effectiveSize = USART2_Receive((uint8_t*) buffer, USART_BUFFER_SIZE, 500);

		asm("NOP"); // juste pour mettre un breakpoint

		if(effectiveSize > 0) {
			USART2_Transmit((uint8_t*) buffer, effectiveSize); // affiche la trame reçue
			memset(buffer, 0, effectiveSize); // nettoie la trame
		}
	}

	// 2.1.3.

	USART2_DeInit();
}
